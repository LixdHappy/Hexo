name: UptimeRobot çŠ¶æ€æ£€æµ‹

on:
  schedule:
    # æ¯ 3 å°æ—¶ä¸€æ¬¡ï¼šUTC 0,3,6,9,12,15,18,21
    - cron: '0 */3 * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai    

jobs:
  check-uptime:
    name: æ£€æŸ¥ UptimeRobot å¹¶åŒæ­¥çŠ¶æ€
    runs-on: ubuntu-latest

    steps:
      - name: éšæœºè·³è¿‡æœºåˆ¶ (50% æ¦‚ç‡è¿è¡Œ)
        id: random-check
        run: |
          if [ $((RANDOM % 2)) -eq 0 ]; then
            echo "skip_job=true" >> $GITHUB_ENV
            echo "æœ¬æ¬¡è§¦å‘è¢«éšæœºè·³è¿‡ âœ…"
          else
            echo "skip_job=false" >> $GITHUB_ENV
            echo "æœ¬æ¬¡è§¦å‘ç»§ç»­æ‰§è¡Œ ğŸš€"
          fi

      - name: æ£€å‡º Hexo æºç ä»“åº“
        if: env.skip_job == 'false'
        uses: actions/checkout@v4

      - name: å®‰è£… Node.js
        if: env.skip_job == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: è¿è¡Œ UptimeRobot çŠ¶æ€æ£€æµ‹è„šæœ¬
        if: env.skip_job == 'false'
        run: node update-status.js
        env:
          UPTIMEROBOT_API_KEY: ${{ secrets.UPTIMEROBOT_API_KEY }}

      - name: ç¡®ä¿ Hexo æºç ä»“åº“è®°å½•æ›´æ–°
        if: env.skip_job == 'false'
        run: |
          touch ./source/status.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ./source/status.json
          git commit -m "ğŸ¤– æ›´æ–°ç›‘æ§çŠ¶æ€ $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push

      - name: å…‹éš†å±•ç¤ºé¡µä»“åº“
        if: env.skip_job == 'false'
        env:
          PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
        run: |
          git clone https://x-access-token:${PUBLISH_TOKEN}@github.com/LixdHappy/LixdHappy.github.io.git publish-repo

      - name: å¤åˆ¶å¹¶æ¨é€ status.json åˆ°å±•ç¤ºä»“åº“
        if: env.skip_job == 'false'
        run: |
          cp ./source/status.json publish-repo/status.json
          cd publish-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json
          git commit -m "ğŸ¤– åŒæ­¥çŠ¶æ€æ–‡ä»¶ $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push

  keepalive-workflow:
    name: Keepalive Workflow
    if: ${{ always() }}
    needs: check-uptime
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: liskin/gh-workflow-keepalive@v1
