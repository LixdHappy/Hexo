# å½“æœ‰æ”¹åŠ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶ï¼Œå¯åŠ¨ Action
name: è‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches:
      - main

  release:
    types:
      - published

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥åˆ†æ”¯
        uses: actions/checkout@v2
        with:
          ref: main

      - name: å®‰è£… Node
        uses: actions/setup-node@v1
        with:
          node-version: "22.x" # æ ¹æ®éœ€è¦ä¿®æ”¹

      - name: å®‰è£… Hexo
        run: |
          export TZ='Asia/Shanghai'
          npm install hexo-cli -g

      - name: ç¼“å­˜ Hexo
        uses: actions/cache@v4
        id: cache
        with:
          path: node_modules
          key: ${{ runner.OS }}-${{ hashFiles('**/package-lock.json') }}

      - name: å®‰è£…ä¾èµ–
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          npm install gulp-cli -g
          npm install --save

      - name: ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆå«é‡è¯•é€»è¾‘ï¼‰
        run: |
          echo "ğŸ” å¼€å§‹ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆæœ€å¤šé‡è¯• 3 æ¬¡ï¼‰"
          n=0
          until [ "$n" -ge 3 ]
          do
            node link.js && \
            node link_alive.js && \
            hexo clean && \
            hexo bangumi -u && \
            hexo generate && \
            hexo swpp && \
            gulp && break

            n=$((n+1))
            echo "âš ï¸ ç”Ÿæˆå¤±è´¥ï¼Œé‡è¯•ç¬¬ $n æ¬¡..."
            sleep 5
          done

          if [ "$n" -ge 3 ]; then
            echo "âŒ ç”Ÿæˆé™æ€æ–‡ä»¶å¤±è´¥ 3 æ¬¡ï¼Œç»ˆæ­¢éƒ¨ç½²"
            exit 1
          fi

      - name: éƒ¨ç½²åˆ° GitHub Pages
        run: |
          cd ./public
          git init
          git config --global user.name '${{ secrets.GITHUBUSERNAME }}'
          git config --global user.email '${{ secrets.GITHUBEMAIL }}'
          git add .
          git commit -m "${{ github.event.head_commit.message }} æ›´æ–°æ¨é€è‡ª $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"

          echo "å¼€å§‹æ¨é€åˆ° GitHub Pages..."
          n=0
          until [ "$n" -ge 3 ]
          do
            git push --force --quiet "https://${{ secrets.GITHUBUSERNAME }}:${{ secrets.GITHUBTOKEN }}@github.com/${{ secrets.GITHUBUSERNAME }}/${{ secrets.GITHUBUSERNAME }}.github.io.git" master:main && break
            n=$((n+1))
            echo "æ¨é€å¤±è´¥ï¼Œé‡è¯•ç¬¬ $n æ¬¡..."
            sleep 5
          done


      # å¦‚æœ‰éœ€è¦ï¼Œå¯ç»§ç»­æ·»åŠ  Coding æˆ– Gitee æ¨é€ï¼ŒåŒæ ·åŠ é‡è¯•ï¼š
      # - name: éƒ¨ç½²åˆ° Coding
      #   run: |
      #     cd ./public
      #     n=0
      #     until [ "$n" -ge 3 ]
      #     do
      #       git push --force --quiet "https://${{ secrets.TOKENUSER }}:${{ secrets.CODINGTOKEN }}@e.coding.net/${{ secrets.CODINGUSERNAME }}/${{ secrets.CODINGBLOGREPO }}.git" master:master && break
      #       n=$((n+1))
      #       echo "Coding æ¨é€å¤±è´¥ï¼Œé‡è¯•ç¬¬ $n æ¬¡..."
      #       sleep 5
      #     done

      # - name: éƒ¨ç½²åˆ° Gitee
      #   run: |
      #     cd ./public
      #     n=0
      #     until [ "$n" -ge 3 ]
      #     do
      #       git push --force --quiet "https://${{ secrets.GITEEUSERNAME }}:${{ secrets.GITEETOKEN }}@gitee.com/${{ secrets.GITEEUSERNAME }}/${{ secrets.GITEEUSERNAME }}.git" master:master && break
      #       n=$((n+1))
      #       echo "Gitee æ¨é€å¤±è´¥ï¼Œé‡è¯•ç¬¬ $n æ¬¡..."
      #       sleep 5
      #     done
