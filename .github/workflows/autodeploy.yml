# 当有改动推送到 main 分支时，启动 Action
name: 自动部署

on:
  push:
    branches:
      - main

  release:
    types:
      - published

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检查分支
        uses: actions/checkout@v2
        with:
          ref: main

      - name: 安装 Node
        uses: actions/setup-node@v1
        with:
          node-version: "22.x" # 根据需要修改

      - name: 安装 Hexo
        run: |
          export TZ='Asia/Shanghai'
          npm install hexo-cli -g

      - name: 缓存 Hexo
        uses: actions/cache@v4
        id: cache
        with:
          path: node_modules
          key: ${{ runner.OS }}-${{ hashFiles('**/package-lock.json') }}

      - name: 安装依赖
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          npm install gulp-cli -g
          npm install --save

      - name: 生成静态文件
        run: |
          node link.js
          node link_alive.js
          node update-status.js
          hexo clean
          hexo bangumi -u
          hexo generate
          hexo swpp
          gulp

      - name: 部署到 GitHub Pages
        run: |
          cd ./public
          git init
          git config --global user.name '${{ secrets.GITHUBUSERNAME }}'
          git config --global user.email '${{ secrets.GITHUBEMAIL }}'
          git add .
          git commit -m "${{ github.event.head_commit.message }} $(date +"%Z %Y-%m-%d %A %H:%M:%S") Updated By Github Actions"

          echo "开始推送到 GitHub Pages..."
          n=0
          until [ "$n" -ge 3 ]
          do
            git push --force --quiet "https://${{ secrets.GITHUBUSERNAME }}:${{ secrets.GITHUBTOKEN }}@github.com/${{ secrets.GITHUBUSERNAME }}/${{ secrets.GITHUBUSERNAME }}.github.io.git" master:main && break
            n=$((n+1))
            echo "推送失败，重试第 $n 次..."
            sleep 5
          done

      # 如有需要，可继续添加 Coding 或 Gitee 推送，同样加重试：
      # - name: 部署到 Coding
      #   run: |
      #     cd ./public
      #     n=0
      #     until [ "$n" -ge 3 ]
      #     do
      #       git push --force --quiet "https://${{ secrets.TOKENUSER }}:${{ secrets.CODINGTOKEN }}@e.coding.net/${{ secrets.CODINGUSERNAME }}/${{ secrets.CODINGBLOGREPO }}.git" master:master && break
      #       n=$((n+1))
      #       echo "Coding 推送失败，重试第 $n 次..."
      #       sleep 5
      #     done

      # - name: 部署到 Gitee
      #   run: |
      #     cd ./public
      #     n=0
      #     until [ "$n" -ge 3 ]
      #     do
      #       git push --force --quiet "https://${{ secrets.GITEEUSERNAME }}:${{ secrets.GITEETOKEN }}@gitee.com/${{ secrets.GITEEUSERNAME }}/${{ secrets.GITEEUSERNAME }}.git" master:master && break
      #       n=$((n+1))
      #       echo "Gitee 推送失败，重试第 $n 次..."
      #       sleep 5
      #     done
