<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexo PJAX缓存更新解决方案</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7f1 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        header {
            background: linear-gradient(120deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }

        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 30px;
            gap: 30px;
        }

        .explanation {
            flex: 1;
            min-width: 300px;
            background: #f8f9fc;
            padding: 25px;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.03);
        }

        .explanation h2 {
            color: #4b6cb7;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeef7;
        }

        .features {
            margin: 20px 0;
        }

        .features li {
            margin-bottom: 12px;
            padding-left: 25px;
            position: relative;
        }

        .features li:before {
            content: "✓";
            position: absolute;
            left: 0;
            top: 0;
            color: #4b6cb7;
            font-weight: bold;
        }

        .demo-section {
            flex: 1;
            min-width: 300px;
        }

        .demo-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .demo-header {
            background: #4b6cb7;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
        }

        .demo-content {
            padding: 25px;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            margin: 20px 0;
        }

        .keyword {
            color: #f92672;
        }

        .function {
            color: #66d9ef;
        }

        .string {
            color: #a6e22e;
        }

        .comment {
            color: #75715e;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(to right, #4b6cb7, #3a56a0);
            color: white;
        }

        .btn-secondary {
            background: #f0f4ff;
            color: #4b6cb7;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 20px;
            max-width: 400px;
            transform: translateX(150%);
            transition: transform 0.4s ease;
            z-index: 1000;
            border-left: 5px solid #4b6cb7;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .notification-title {
            font-weight: bold;
            color: #4b6cb7;
            font-size: 1.1rem;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
        }

        .notification-content {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .notification-footer {
            display: flex;
            justify-content: flex-end;
        }

        .status-bar {
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .status-value {
            font-weight: 600;
            color: #4b6cb7;
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }

            h1 {
                font-size: 2.2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Hexo博客PJAX缓存更新解决方案</h1>
            <p class="subtitle">在开启PJAX的情况下实现CSS/JS资源的无缝更新和用户刷新提示</p>
        </header>

        <div class="content">
            <div class="explanation">
                <h2>解决方案说明</h2>
                <p>该方案解决了Hexo博客在使用PJAX技术时的资源更新问题，通过Service Worker检测更新，智能替换CSS/JS资源，并提供优雅的用户刷新提示。</p>

                <h3>主要功能：</h3>
                <ul class="features">
                    <li>通过Service Worker检测静态资源更新</li>
                    <li>动态替换已更新的CSS和JavaScript文件</li>
                    <li>自动处理资源依赖关系</li>
                    <li>提供用户友好的更新提示</li>
                    <li>支持自动更新和手动刷新两种模式</li>
                    <li>保留所有原始元素属性和内容</li>
                </ul>

                <h3>使用场景：</h3>
                <p>适用于使用PJAX技术的Hexo博客，当静态资源更新后，无需用户完全刷新页面即可应用新版本资源，同时对于需要完全刷新的情况提供明确提示。</p>

                <div class="status-bar">
                    <div class="status-item">
                        <span>当前状态：</span>
                        <span class="status-value" id="statusValue">等待更新检测</span>
                    </div>
                    <div class="status-item">
                        <span>最后更新时间：</span>
                        <span class="status-value" id="updateTime">尚未更新</span>
                    </div>
                </div>
            </div>

            <div class="demo-section">
                <div class="demo-card">
                    <div class="demo-header">核心代码实现</div>
                    <div class="demo-content">
                        <div class="code-block">
                            <span class="keyword">function</span> <span class="function">pjaxUpdate</span>(url) {<br>
                            &nbsp;&nbsp;<span class="keyword">return new</span> <span
                                class="function">Promise</span>(resolve => {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 检测资源类型 (CSS/JS)</span><br>
                            &nbsp;&nbsp;&nbsp;&nbsp;const type = url.endsWith(<span class="string">'js'</span>) ? <span
                                class="string">'script'</span> : <span class="string">'link'</span>;<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;const name = type === <span class="string">'link'</span> ? <span
                                class="string">'href'</span> : <span class="string">'src'</span>;<br><br>

                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 查找现有资源元素</span><br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (let item of
                            document.querySelectorAll(type)) {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const itUrl = item[name];<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (itUrl &&
                            (url.endsWith(itUrl) || itUrl.endsWith(url))) {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//
                                创建新元素并复制所有属性</span><br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const newEle =
                            document.createElement(type);<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Array.from(item.attributes).forEach(attr =>
                            {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newEle.setAttribute(attr.name,
                            attr.value);<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>

                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//
                                复制内容（仅对script有效）</span><br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const content = item.text ||
                            item.textContent || item.innerHTML || <span class="string">''</span>;<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (content)
                            newEle.appendChild(document.createTextNode(content));<br><br>

                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//
                                替换元素并触发更新</span><br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item.parentNode.replaceChild(newEle,
                            item);<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span
                                class="function">resolve</span>(<span class="keyword">true</span>);<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="function">resolve</span>(<span
                                class="keyword">false</span>);<br>
                            &nbsp;&nbsp;});<br>
                            }<br><br>

                            <span class="comment">// 初始化Service Worker通信</span><br>
                            <span class="keyword">if</span> (<span class="string">'serviceWorker'</span> <span
                                class="keyword">in</span> navigator && navigator.serviceWorker.controller) {<br>
                            &nbsp;&nbsp;navigator.serviceWorker.controller.postMessage(<span
                                class="string">'update'</span>);<br>
                            &nbsp;&nbsp;navigator.serviceWorker.addEventListener(<span class="string">'message'</span>,
                            event => {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;const data = event.data;<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">switch</span> (data.type) {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">case</span> <span
                                class="string">'update'</span>:<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//
                                处理资源更新...</span><br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
                                class="function">showUpdateNotification</span>(data.update);<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">break</span>;<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">case</span> <span
                                class="string">'refresh'</span>:<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location.reload();<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">break</span>;<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                            &nbsp;&nbsp;});<br>
                            }
                        </div>

                        <p>此代码实现了资源检测、动态更新和用户提示功能，完整代码请查看页面底部。</p>

                        <div class="button-group">
                            <button class="btn btn-primary" id="simulateUpdate">
                                <i class="fa fa-refresh"></i> 模拟资源更新
                            </button>
                            <button class="btn btn-secondary" id="viewFullCode">
                                <i class="fa fa-code"></i> 查看完整代码
                            </button>
                        </div>
                    </div>
                </div>

                <div class="demo-card">
                    <div class="demo-header">功能演示</div>
                    <div class="demo-content">
                        <p>点击下方按钮模拟不同更新场景：</p>

                        <div class="button-group">
                            <button class="btn btn-primary" id="demoCssUpdate">
                                <i class="fa fa-css3"></i> 模拟CSS更新
                            </button>
                            <button class="btn btn-primary" id="demoJsUpdate">
                                <i class="fa fa-code"></i> 模拟JS更新
                            </button>
                            <button class="btn btn-secondary" id="demoFullUpdate">
                                <i class="fa fa-refresh"></i> 模拟完整更新
                            </button>
                        </div>

                        <div class="status-bar" style="margin-top: 25px;">
                            <div class="status-item">
                                <span>当前CSS版本：</span>
                                <span class="status-value" id="cssVersion">v1.0.0</span>
                            </div>
                            <div class="status-item">
                                <span>当前JS版本：</span>
                                <span class="status-value" id="jsVersion">v1.0.0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="updateNotification">
        <div class="notification-header">
            <div class="notification-title">博客已更新</div>
            <button class="notification-close">&times;</button>
        </div>
        <div class="notification-content">
            检测到新的博客更新，刷新页面以查看最新内容。部分更新已自动应用，但完整更新需要刷新页面。
        </div>
        <div class="notification-footer">
            <button class="btn btn-secondary" id="refreshLater">稍后刷新</button>
            <button class="btn btn-primary" id="refreshNow">立即刷新</button>
        </div>
    </div>

    <script>
        // 模拟的kms对象
        const kms = {
            pushInfo: function (message, button, timeout) {
                document.getElementById('updateNotification').querySelector('.notification-content').textContent = message;
                showNotification();

                if (timeout) {
                    setTimeout(() => {
                        hideNotification();
                    }, timeout);
                }
            },
            queryOption: function (option) {
                return localStorage.getItem(option) === 'true';
            },
            compareUrls: function (url1, url2) {
                // 简化版的URL比较
                return url1.replace(/https?:\/\//, '') === url2.replace(/https?:\/\//, '');
            }
        };

        // 显示通知
        function showNotification() {
            const notification = document.getElementById('updateNotification');
            notification.classList.add('show');
        }

        // 隐藏通知
        function hideNotification() {
            const notification = document.getElementById('updateNotification');
            notification.classList.remove('show');
        }

        // 关闭按钮事件
        document.querySelector('.notification-close').addEventListener('click', hideNotification);
        document.getElementById('refreshLater').addEventListener('click', hideNotification);

        // 立即刷新按钮事件
        document.getElementById('refreshNow').addEventListener('click', function () {
            localStorage.setItem('update', new Date().toLocaleString());
            document.getElementById('updateTime').textContent = new Date().toLocaleString();
            document.getElementById('statusValue').textContent = '已刷新页面';
            hideNotification();

            // 在实际应用中这里应该是location.reload()
            alert('页面已刷新！');
        });

        // 模拟更新按钮事件
        document.getElementById('simulateUpdate').addEventListener('click', function () {
            showNotification();
        });

        // 模拟CSS更新
        document.getElementById('demoCssUpdate').addEventListener('click', function () {
            document.getElementById('cssVersion').textContent = 'v1.0.' + Math.floor(Math.random() * 10);
            kms.pushInfo('CSS文件已更新到最新版本，无需刷新页面。');
            document.getElementById('statusValue').textContent = 'CSS已更新';
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
        });

        // 模拟JS更新
        document.getElementById('demoJsUpdate').addEventListener('click', function () {
            document.getElementById('jsVersion').textContent = 'v1.0.' + Math.floor(Math.random() * 10);
            kms.pushInfo('JavaScript文件已更新到最新版本，无需刷新页面。');
            document.getElementById('statusValue').textContent = 'JS已更新';
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
        });

        // 模拟完整更新
        document.getElementById('demoFullUpdate').addEventListener('click', function () {
            kms.pushInfo('检测到博客核心更新，请刷新页面以获取最新内容。');
            document.getElementById('statusValue').textContent = '需要完整刷新';
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
        });

        // 查看完整代码
        document.getElementById('viewFullCode').addEventListener('click', function () {
            alert('完整代码已在页面中实现，请查看JavaScript部分。');
        });

        // 实际更新函数
        function pjaxUpdate(url) {
            return new Promise(resolve => {
                const type = url.endsWith('js') ? 'script' : 'link';
                const name = type.length === 4 ? 'href' : 'src';

                for (let item of document.querySelectorAll(type)) {
                    const itUrl = item[name];
                    if (itUrl && (url.length > itUrl ? url.endsWith(itUrl) : itUrl.endsWith(url))) {
                        const newEle = document.createElement(type);
                        const content = item.text || item.textContent || item.innerHTML || '';

                        // 复制所有属性
                        Array.from(item.attributes).forEach(attr => {
                            newEle.setAttribute(attr.name, attr.value);
                        });

                        // 复制内容
                        if (content) {
                            newEle.appendChild(document.createTextNode(content));
                        }

                        // 替换元素
                        item.parentNode.replaceChild(newEle, item);
                        return resolve(true);
                    }
                }
                resolve(false);
            });
        }

        // Service Worker 通信
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage('update');

            navigator.serviceWorker.addEventListener('message', event => {
                const data = event.data;
                switch (data.type) {
                    case 'update':
                        if (!data.update?.length) break;

                        localStorage.setItem('update', new Date().toLocaleString());
                        document.getElementById('updateTime').textContent = new Date().toLocaleString();

                        const list = data.update;
                        if (!list) break;

                        const button = {
                            text: '刷新',
                            desc: '点击刷新页面',
                            onclick: () => {
                                Promise.all(list.map(url => {
                                    if (url.endsWith('.js')) return pjaxUpdate(url);
                                    if (url.endsWith('.css')) return pjaxUpdate(url);
                                    return Promise.resolve(url.endsWith('.json') || kms.compareUrls(url, location.href));
                                })).then(results => {
                                    if (results.some(result => result)) {
                                        localStorage.setItem('update', new Date().toLocaleString());
                                        location.reload();
                                    } else {
                                        sessionStorage.removeItem('updated');
                                        kms.pushInfo('所有资源已更新完成！');
                                    }
                                });
                            }
                        };

                        if (kms.queryOption('auto-update')) {
                            sessionStorage.setItem('updated', true);
                            button.onclick();
                        } else {
                            kms.pushInfo('博客已更新，点击刷新按钮以显示最新内容', button, 15000);
                        }
                        break;

                    case 'refresh':
                        localStorage.setItem('update', new Date().toLocaleString());
                        location.reload();
                        break;
                }
            });
        }

        // 初始化更新时间显示
        const lastUpdate = localStorage.getItem('update');
        if (lastUpdate) {
            document.getElementById('updateTime').textContent = lastUpdate;
        }
    </script>
</body>

</html>